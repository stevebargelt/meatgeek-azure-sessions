# Builds the MeatGeek sessions microservice resources
name: $(BuildID)

resources:
  repositories:
    - repository: self
      type: github
      endpoint: stevebargelt
      name: stevebargelt/meatgeek-azure-sessions
      trigger:
        branches:
          include:
            - main
        paths:
          exclude:
            - docs
            - mkdocs.yml
            - build/build-docs.yaml

    - repository: shared
      type: github
      endpoint: stevebargelt
      name: stevebargelt/MeatGeek-Shared

pool:
  vmImage: ubuntu-latest

steps:
- checkout: self
- checkout: shared
  
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: "specific"
      project: "30f6773c-aaa9-4787-adae-f89abac99210"
      pipeline: "15"
      buildVersionToDownload: "latest"
      downloadType: "single"
      downloadPath: "$(System.ArtifactsDirectory)"

  # Build the APIs
  - task: DotNetCoreCLI@1
    displayName: Run dotnet restore
    inputs:
      command: "restore"
      projects: "src/**/*.csproj"

  - task: DotNetCoreCLI@1
    displayName: Run dotnet build
    inputs:
      projects: "src/**/*.csproj"

  - task: DotNetCoreCLI@1
    displayName: Run dotnet publish
    inputs:
      command: "publish"
      publishWebProjects: "False"
      projects: "src/**/*Api.csproj"
      arguments: "--output $(build.artifactstagingdirectory)"
      zipAfterPublish: "True"

  # Publish the APIs as an artifact
  - task: PublishBuildArtifacts@1
    displayName: Publish Azure Functions
    inputs:
      pathToPublish: $(build.artifactstagingdirectory)
      artifactName: functions
      artifactType: container

  # Publish the `deploy` folder as an artifact
  - task: PublishBuildArtifacts@1
    displayName: Publish Deployment Scripts
    inputs:
      pathToPublish: deploy
      artifactName: deploy
      artifactType: container
