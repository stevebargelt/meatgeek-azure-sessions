# Builds the MeatGeek sessions microservice resources

name: $(BuildID)
steps:
  # Build the APIs
  - task: DotNetCoreCLI@1
    displayName: Run dotnet restore
    inputs:
      command: "restore"
      projects: "src/**/*.csproj"

  - task: DotNetCoreCLI@1
    displayName: Run dotnet build
    inputs:
      projects: "src/**/*.csproj"

  - task: DotNetCoreCLI@1
    displayName: Run dotnet publish
    inputs:
      command: "publish"
      publishWebProjects: "False"
      projects: "src/**/*Api.csproj"
      arguments: "--output $(build.artifactstagingdirectory)"
      zipAfterPublish: "True"

  # Publish the APIs as an artifact
  - task: PublishBuildArtifacts@1
    displayName: Publish Azure Functions
    inputs:
      pathToPublish: $(build.artifactstagingdirectory)
      artifactName: functions
      artifactType: container

  # Publish the `deploy` folder as an artifact
  - task: PublishBuildArtifacts@1
    displayName: Publish Deployment Scripts
    inputs:
      pathToPublish: deploy
      artifactName: deploy
      artifactType: container

  # - task: PowerShell@2
  #   inputs:
  #     filePath: "$(System.DefaultWorkingDirectory)/deploy/CreateUniqueResourceNameSuffix.ps1"

  # - task: AzureResourceManagerTemplateDeployment@3
  #   inputs:
  #     deploymentScope: "Resource Group"
  #     azureResourceManagerConnection: "Visual Studio Enterprise(2394ff5d-4d73-4134-a00f-2385754aeeb5)"
  #     subscriptionId: "2394ff5d-4d73-4134-a00f-2385754aeeb5"
  #     action: "Create Or Update Resource Group"
  #     resourceGroupName: "MeatGeek-Sessions"
  #     location: "West US 2"
  #     templateLocation: "Linked artifact"
  #     csmFile: "$(System.DefaultWorkingDirectory)/deploy/microservice.json"
  #     overrideParameters: "-uniqueResourceNameSuffix $(UniqueResourceNameSuffix)"
  #     deploymentMode: "Incremental"

  # - task: AzureRmWebAppDeployment@4
  #   inputs:
  #     ConnectionType: "AzureRM"
  #     azureSubscription: "Visual Studio Enterprise(2394ff5d-4d73-4134-a00f-2385754aeeb5)"
  #     appType: "functionApp"
  #     WebAppName: "$(functionsApiAppName)"
  #     packageForLinux: "$(Build.ArtifactStagingDirectory)/**/*.zip"
